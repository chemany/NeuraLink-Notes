/** @type {import('next').NextConfig} */
const path = require('path');

const nextConfig = {
  // å¯ç”¨ basePath ç”¨äºä»£ç†ç¯å¢ƒ
  basePath: '/notepads',
  assetPrefix: '/notepads',
  trailingSlash: true,
  reactStrictMode: true,
  swcMinify: true,
  
  // æ€§èƒ½ä¼˜åŒ–é…ç½®
  experimental: {
    optimizePackageImports: ['react', 'react-dom', 'lucide-react'], // ä¼˜åŒ–åŒ…å¯¼å…¥
    optimizeCss: false, // æš‚æ—¶ç¦ç”¨CSSä¼˜åŒ–é¿å…æ„å»ºé—®é¢˜
  },
  
  // ğŸš€ ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ä¼˜åŒ–
  poweredByHeader: false, // ç§»é™¤X-Powered-By header
  compress: true, // å¯ç”¨å‹ç¼©
  
  // å›¾ç‰‡ä¼˜åŒ–é…ç½®
  images: {
    formats: ['image/avif', 'image/webp'],
    minimumCacheTTL: 60,
  },
  
  // ç¼–è¯‘ä¼˜åŒ–
  compiler: {
    removeConsole: process.env.NODE_ENV === 'production' ? {
      exclude: ['error', 'warn'],
    } : false,
    // ç”Ÿäº§ç¯å¢ƒå¯ç”¨SWCå‹ç¼©
    styledComponents: process.env.NODE_ENV === 'production',
  },
  
  // ğŸ¯ è¾“å‡ºä¼˜åŒ–
  output: 'standalone', // ä¼˜åŒ–Dockeréƒ¨ç½²
  webpack: (config, { isServer, dev }) => {
    // å¤„ç†PDF.jsçš„canvasä¾èµ–é—®é¢˜
    if (isServer) {
      config.resolve.alias = {
        ...config.resolve.alias,
        canvas: path.resolve(__dirname, 'src/mocks/canvasMock.js'),
      };
    }
    
    // å…è®¸åŠ è½½å¤–éƒ¨ worker è„šæœ¬
    config.resolve.alias.canvas = false;
    
    // ğŸš€ ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ä¼˜åŒ–
    if (!dev && !isServer) {
      // ä»£ç åˆ†å‰²ä¼˜åŒ–
      config.optimization.splitChunks = {
        chunks: 'all',
        cacheGroups: {
          // ç¬¬ä¸‰æ–¹åº“å•ç‹¬æ‰“åŒ…
          vendor: {
            test: /[\\/]node_modules[\\/]/,
            name: 'vendors',
            priority: 10,
            chunks: 'all',
            enforce: true,
          },
          // å…¬å…±ç»„ä»¶å•ç‹¬æ‰“åŒ…
          common: {
            minChunks: 2,
            chunks: 'all',
            enforce: true,
            priority: 5,
            name: 'common',
          },
          // Reactç›¸å…³å•ç‹¬æ‰“åŒ…
          react: {
            test: /[\\/]node_modules[\\/](react|react-dom)[\\/]/,
            name: 'react',
            priority: 20,
            chunks: 'all',
            enforce: true,
          },
        },
      };
      
      // å‹ç¼©é…ç½®
      config.optimization.minimize = true;
    }
    
    return config;
  },
  // é…ç½®å®‰å…¨ç­–ç•¥ä»¥å…è®¸åŠ è½½ PDF worker
  // æš‚æ—¶ç¦ç”¨CORSå¤´ï¼Œé¿å…åœ¨HTTPç¯å¢ƒä¸‹çš„è­¦å‘Š
  // async headers() {
  //   return [
  //     {
  //       source: '/:path*',
  //       headers: [
  //         {
  //           key: 'Cross-Origin-Opener-Policy',
  //           value: 'same-origin',
  //         },
  //         {
  //           key: 'Cross-Origin-Embedder-Policy',
  //           value: 'require-corp',
  //         },
  //       ],
  //     },
  //   ];
  // },

  // Re-enable rewrites for local development proxying
  async rewrites() {
    const rewrites = [];
    
    // APIé‡å†™è§„åˆ™ - ç”Ÿäº§ç¯å¢ƒä¹Ÿéœ€è¦ï¼Œå› ä¸ºåº”ç”¨å¯èƒ½ç›´æ¥è®¿é—®è€Œä¸é€šè¿‡nginxä»£ç†
    // æ”¯æŒbasePathä¸‹çš„APIè¯·æ±‚
    rewrites.push({
      source: '/api/:path*',
      destination: `${process.env.BACKEND_API_URL || 'http://localhost:3001/api'}/:path*`,
    });

    // æ”¯æŒbasePathç¯å¢ƒä¸‹çš„APIé‡å†™ï¼ˆå¦‚ /notepads/api/* -> localhost:3001/api/*ï¼‰
    rewrites.push({
      source: '/notepads/api/:path*',
      destination: `${process.env.BACKEND_API_URL || 'http://localhost:3001/api'}/:path*`,
    });
    
    // æ·»åŠ å¼€å‘å·¥å…·ç›¸å…³çš„é‡å†™è§„åˆ™ï¼Œé¿å…404é”™è¯¯
    rewrites.push(
      // é™é»˜å¤„ç†Chromeå¼€å‘å·¥å…·è¯·æ±‚
      {
        source: '/.well-known/:path*',
        destination: '/api/dev-tools-silence', // è¿”å›ç©ºå“åº”
      },
      // å¤„ç†source mapè¯·æ±‚
      {
        source: '/:path*\\.map',
        destination: '/api/dev-tools-silence',
      },
      // å¤„ç†faviconè¯·æ±‚ - é‡å®šå‘åˆ°å­˜åœ¨çš„å›¾æ ‡
      {
        source: '/notepads/favicon.svg',
        destination: '/favicon-alt.svg', // é‡å®šå‘åˆ°æˆ‘ä»¬åˆ›å»ºçš„SVGå›¾æ ‡
      },
      // å¤„ç†manifestè¯·æ±‚
      {
        source: '/notepads/manifest.json',
        destination: '/manifest.json',
      }
    );
    
    return rewrites;
  },
  
  // ğŸ¯ æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–
  onDemandEntries: {
    // é¡µé¢åœ¨å†…å­˜ä¸­ä¿æŒçš„æ—¶é—´
    maxInactiveAge: 25 * 1000,
    // åŒæ—¶ä¿æŒåœ¨å†…å­˜ä¸­çš„é¡µé¢æ•°
    pagesBufferLength: 2,
  },
}

module.exports = nextConfig; 